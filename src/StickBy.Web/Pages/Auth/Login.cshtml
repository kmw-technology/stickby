@page
@model LoginModel
@inject ILocalizationService L
@{
    ViewData["Title"] = L["auth.login"];
    var qrImageUrl = $"https://api.qrserver.com/v1/create-qr-code/?size=232x232&data={Uri.EscapeDataString(Model.PairingToken ?? "")}";
}

<div class="qr-login">
    <div class="qr-header">
        <h1>StickBy Web</h1>
        <p class="qr-subtitle">@L["auth.scanToLogin"]</p>

        <div class="qr-instructions">
            <h3>@L["auth.howToConnect"]</h3>
            <ol>
                <li>@L["auth.step1OpenApp"]</li>
                <li>@L["auth.step2GoToSettings"]</li>
                <li>@L["auth.step3ScanQr"]</li>
            </ol>
        </div>

        <div class="qr-app-link">
            <p>@L["auth.noApp"]</p>
            <a href="~/Auth/Register" class="btn-secondary">@L["auth.downloadApp"]</a>
        </div>
    </div>

    <div class="qr-wrapper">
        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="error-message">@Model.ErrorMessage</div>
        }

        @if (!string.IsNullOrEmpty(Model.PairingToken))
        {
            <div id="qrcode" class="qr-code">
                <img src="@qrImageUrl" alt="QR Code" width="232" height="232" />
            </div>
            <div id="qr-status" class="qr-status">
                <div class="spinner"></div>
                <span>@L["auth.waitingForScan"]</span>
            </div>
            <div id="qr-expired" class="qr-expired" style="display: none;">
                <span>@L["auth.qrExpired"]</span>
                <button onclick="window.location.reload()" class="btn-secondary">
                    @L["auth.refreshQr"]
                </button>
            </div>

            <form id="completeForm" method="post" asp-page-handler="Complete" style="display: none;">
                <input type="hidden" name="token" id="tokenInput" value="@Model.PairingToken" />
            </form>
        }
    </div>
</div>

@section Scripts {
    <script>
        (function() {
            const pairingToken = '@Model.PairingToken';
            const expiresAt = new Date('@Model.ExpiresAt?.ToString("o")');

            if (!pairingToken) return;

            const qrContainer = document.getElementById('qrcode');
            const statusEl = document.getElementById('qr-status');
            const expiredEl = document.getElementById('qr-expired');
            const completeForm = document.getElementById('completeForm');

            let pollInterval;

            function checkStatus() {
                // Check if expired
                if (new Date() >= expiresAt) {
                    clearInterval(pollInterval);
                    statusEl.style.display = 'none';
                    expiredEl.style.display = 'flex';
                    qrContainer.style.opacity = '0.3';
                    return;
                }

                fetch(`?handler=Status&token=${encodeURIComponent(pairingToken)}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'authorized') {
                            clearInterval(pollInterval);
                            statusEl.innerHTML = '<span style="color: var(--success-color);">âœ“ @L["auth.connected"]</span>';
                            completeForm.submit();
                        } else if (data.status === 'expired' || data.status === 'invalidated') {
                            clearInterval(pollInterval);
                            statusEl.style.display = 'none';
                            expiredEl.style.display = 'flex';
                            qrContainer.style.opacity = '0.3';
                        }
                    })
                    .catch(err => console.error('Status check failed:', err));
            }

            // Start polling every 2 seconds
            pollInterval = setInterval(checkStatus, 2000);
            checkStatus();
        })();
    </script>
}

<style>
    .qr-app-link {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border);
    }

    .qr-app-link p {
        color: var(--text-muted);
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
    }

    .qr-code img {
        display: block;
        border-radius: 8px;
    }
</style>

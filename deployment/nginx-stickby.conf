# =============================================================================
# StickBy nginx Configuration
# =============================================================================
# Add these sections to /opt/infrastructure/nginx.conf on the Hetzner server
#
# UPSTREAMS: Add to the http block, with other upstreams
# LOCATIONS: Add to the server block (HTTPS), before the fallback location
# =============================================================================

# -----------------------------------------------------------------------------
# UPSTREAMS (add to http block)
# -----------------------------------------------------------------------------

upstream stickby-website {
    server stickby-website:8080;
}

upstream stickby-backend {
    server stickby-backend:8080;
}

upstream stickby-admin {
    server stickby-admin:8080;
}

# -----------------------------------------------------------------------------
# LOCATIONS (add to server block)
# -----------------------------------------------------------------------------

# StickBy Website (Razor Pages)
location /stickby/website {
    proxy_pass http://stickby-website;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-PathBase /stickby/website;
    proxy_connect_timeout 60s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    client_max_body_size 10M;
}

# StickBy Backend API
location /stickby/backend {
    proxy_pass http://stickby-backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-PathBase /stickby/backend;
    proxy_connect_timeout 60s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    client_max_body_size 200M;
}

# StickBy Admin Panel - Blazor SignalR WebSocket
location /stickby/admin-panel/_blazor {
    proxy_pass http://stickby-admin;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-PathBase /stickby/admin-panel;
    proxy_read_timeout 86400s;
    proxy_send_timeout 86400s;
    proxy_socket_keepalive on;
    tcp_nodelay on;
}

# StickBy Admin Panel (Blazor Server)
location /stickby/admin-panel {
    proxy_pass http://stickby-admin;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-PathBase /stickby/admin-panel;
    proxy_connect_timeout 60s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    client_max_body_size 10M;
}
